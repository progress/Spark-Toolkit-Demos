/*------------------------------------------------------------------------
    File        : WebContext.cls
    Purpose     : Simple class for User context data
    Author(s)   : Dustin Grau (dugrau@progress.com)
    Created     : Wed Feb 21 11:25:07 EST 2018
    Notes       :
  ----------------------------------------------------------------------*/

@program FILE(name="WebContext.cls", module="AppServer").
@openapi.openedge.export FILE(type="REST", executionMode="singleton", useReturnValue="false", writeDataSetBeforeImage="false").
@progress.service.resource FILE(name="context", URI="/context", schemaName="dsWebContext", schemaFile="Sports/PASOEContent/WEB-INF/openedge/Common/webcontext.i").

using Progress.Lang.* from propath.
using Progress.Json.ObjectModel.* from propath.

block-level on error undo, throw.

class Business.UserContext inherits Spark.Core.Service.SparkEntity use-widget-pool:

    {Common/webcontext.i}

    constructor public UserContext ( ):
        ProDataSet = dataset dsWebContext:handle.

        /* Data Source for each table in dataset. Should be in table order as defined in DataSet */
        extent(DataSourceArray) = 1.
        create data-source DataSourceArray[1].
        DataSourceArray[1]:add-source-buffer(buffer WebContext:handle, ?).
        ProDataSource = DataSourceArray.

        /* Skip-list entries for each table in dataset. Should be in temp-table order as defined in DataSet. */
        /* Each skip-list entry is a comma-separated list of field names, to be ignored in create statement. */
        extent(SkipListArray) = 1.
        SkipListArray[1] = "".
        SkipList = SkipListArray.
    end constructor.


    method protected override character validateData ( input pcAction as character,
                                                       input-output dataset-handle phDataset ):
        define variable bhTopTable as handle  no-undo.
        define variable bhBefore   as handle  no-undo.
        define variable hQuery     as handle  no-undo.
        define variable lAvail     as logical no-undo.
        define variable iBuffers   as integer no-undo.
        define variable ix         as integer no-undo.
        define variable iy         as integer no-undo.

        if not valid-handle(phDataset) then return "".

        assign iBuffers = phDataset:num-top-buffers.
        do ix = 1 to iBuffers:
            assign bhTopTable = phDataset:get-top-buffer(ix).
            bhTopTable:table-handle:tracking-changes = true.
            assign bhBefore = bhTopTable:before-buffer.

            create query hQuery.
            hQuery:set-buffers(bhBefore).
            hQuery:query-prepare(substitute('FOR EACH &1', bhBefore:name)).
            hQuery:query-open().
            assign lAvail = hQuery:get-first(no-lock).

            VALIDATEBLK:
            do while lAvail:
                if bhBefore:row-state eq row-deleted then do:
                    /* This will return an error to indicate delete is not allowed. */
                    undo, throw new AppError("Delete operation is not allowed.", -500).

                    /* If delete IS allowed, then this method should return blank. */
                    /* return "". */
                end. /* row-deleted */

                if bhTopTable:find-first(substitute("where rowid(&1) eq to-rowid('&2')", bhTopTable:name, bhBefore:after-rowid)) then
                do iy = 1 to bhTopTable:num-fields:
                    if bhTopTable:row-state eq row-created then do:
                        /* Always assign the current username as the IdentityName field. */
                        if bhTopTable:buffer-field(iy):name eq "IdentityName" then
                            bhTopTable:buffer-field(iy):buffer-value = oClientContext:userID.
                    end. /* row-created */

                    if bhTopTable:row-state eq row-modified then do:
                        /* Always assign the current username as the IdentityName field. */
                        if bhTopTable:buffer-field(iy):name eq "IdentityName" then
                            bhTopTable:buffer-field(iy):buffer-value = oClientContext:userID.
                    end. /* row-modified */
                end. /* table field */
                assign lAvail = hQuery:get-next(no-lock).
            end. /* lAvail */
        end. /* do ix */

        return "".

        finally:
            hQuery:query-close() no-error.
            delete object hQuery no-error.
            delete object bhTopTable no-error.
            delete object bhBefore no-error.
        end finally.
    end method. /* validateData */


    @openapi.openedge.export(type="REST", useReturnValue="false", writeDataSetBeforeImage="true").
    @progress.service.resourceMapping(type="REST", operation="read", URI="?filter=骈祠弪", alias="", mediaType="application/json").
    @openapi.openedge.method.property(name="mappingType", value="AFP").
    @openapi.openedge.method.property(name="capabilities", value="filter,top,skip,id,sort,orderBy").
    method public void ReadContext ( input filter as character, output dataset dsWebContext ):
        define variable oFilterObj as JsonObject no-undo.
        define variable oFilter    as JsonObject no-undo.
        define variable oFilters   as JsonArray  no-undo.
        define variable oCriteria  as JsonObject no-undo.
        define variable ix         as integer    no-undo.
        define variable lFound     as logical    no-undo.

        assign lFound = false.
        if filter begins "翳孱狍箝珙锲殪翦蛳怅翳轶镡赍泗虹弭崎祠弪ㄦ殪翦颟殒鲠扉洵镡赍泗锲殪翦蛳怅翳孱滹殒锲殪翦蛳怅喝狍á骈祠弪犷锲殪翦蛳怅喝狍á沆殄铘犷锲殪翦蛳怅呵弭描狎徙翦颞沆殄铘羼⑺孱滹丈翳孱滹狍箝珙锲殪翦锲殪翦蛳怅呵弭鼠镱镶赍泗á骈祠弪┊殒鲠扉洵镡赍泗锲殪翦颟犷锲殪翦蚝柔蟥㈡殪翦蝮翳孱狍箝珙锲殪翦蝮锲殪翦蚝清羰箫盍蝌狴á骈祠弪螈┊殒鲠扉洵镡赍泗锲殪翦蝮翳孱滹轼麸锲殪翦蝮红孱玺韬涉骈祠弪狯衢灬忪瀣祜镫骘骈屐⑸溴铘轸吾礤狍箝珙锩蜷翦蜷锲殪翦蝮呵弭鼠镱镶赍泗ㄩ┊殒锩蜷翦蜷岷柔蟥㈡殄熹犷锩蜷翦蜷岷清裘栳蜥泗弪á骈屐洧羼⑸溴铘轸吾礤翳孱滹狍箝珙炱秕钿趄蹂深怙躅骈祠弪栳骈祠弪泸轸弪獒轸屙骘射孱糸豉吾礤锩蜷翦蜷岷渝舁Ⅵ犰蹂锩扉孱裘镱翦艉躞弪赡┊霄弪蜷溴鏖翳翳沲蝌孱躞弪钺礤孱洚骘躅骈屐孱洚滹轼麸锲殪翦蝮红孱玺孱洚锲殪翦蛳怅喝狍á骈祠弪鬯孱滹丈孱洚鲠扉洵镡赍泗锲殪翦蛳怅殒铒炱秕钿翳孱滹拈铒骈钿骈祠弪泸轸弪獒怡骈屐钺礤箫泸遽翦轸狍箝珙锩蜷翦蜷铄鼠镱镶赍泗ī锩蜷翦蜷岷龄洙㈡殄熹⑸溴铘轸吾礤┊锩蜷翦蜷岷龄洙镳弪狒矧㈠聃犰螈┊锩蜷翦蜷岷龄洙Ⅵ犰蹂锩扉孱裘镱翦艉躞弪赡┊抿遽翦骈祠弪狎蜥殒轸滹弩瞌屮轶舢殒铒鲠扉洵镡赍泗锲殪翦蝮翳孱狍箝珙锲殪翦蝮铄鼠镱硫蜥ī龄翳铄泸轸弪獒轸屙麸翳骈祠弪扉篝锲殪翦蝮毫滗锩蜷翦蜷岍抿遽翦汨殪骈祠弪镡赍泗殒轸滹弩瞌屮轶舢殒铒鲠扉洵镡赍泗锲殪翦颟翳孱狍箝珙锲殪翦铄鼠镱镶赍泗ī震溽翦矧泸遽翦翳骈祠弪痱镳弪豉殒锲殪翦蚝柔蟥㈡殪翦蝮翳孱滹锲殪翦蚝渝舁㈧镧殂⑨钿┊锲殪翦蚝渝舁㈡殪翦蝮锲殪翦蝮┊孱洚骈祠弪屮轶趔屐箦滹锲殪翦蚝龄洙㈧镧殂⑨钿┊锲殪翦蚝龄洙㈡殪翦蝮锲殪翦蝮┊孱洚滹弩瞌屮轶抿遽翦疳蝈铘骈祠弪镡赍泗殒轸滹弩瞌屮轶舢殒铒鲠扉洵镡赍泗锲殪翦蛳怅翳孱狍箝珙锲殪翦蛳怅铄鼠镱镶赍泗ī震溽翦矧泸遽翦翳骈祠弪痱镳弪豉殒锲殪翦蛳怅喝狍á骈祠弪翳孱锲殪翦蛳怅河弭á骈祠弪锲殪翦颟屐箦滹锲殪翦蛳怅毫滗á沆殄铘⑺孱滹丈┊锲殪翦蛳怅毫滗á骈祠弪锲殪翦颟孱洚孱洚铒炱秕钿义趱蝾犰翦蝈骈祠弪骝镯徜牾篝邃视衔镡赍泗狍箝珙骈祠弪锲殪翦蛳怅呵弭鼠镱藻舁┊溴骈铄鲠蜷徕戾槲蹴义泱狍轭舳铒躅滹篚疱蚝义徜尼翎ㄦ殪翦颥槲蹴义泱秕麴豸溽翎箦潴族饷镱翦怡蝈驽蝈钽濠孱礤翳镤义徜蔑铘屮里疱钺痖镳孱邃珏屮痫螋豉疱舰遗釉躞逡弭躜钪犰蹂舰驷祗澧黩轸迥狒嵊弭洛骘蝈身徵褰Ⅳ蝓澧┊鲤蝻珧弩螽箦蝣殂瀹蝈箫躜沐歪痧轭绋豉疱舰遗釉镳弪狒轱罱Ⅲ踱黹簪找山篚忭轸犰獒蠼Ⅲ踱黹簪礤溟嵩疱舰狃痨殂狒轱畀牦镱┊礤翳镤瘐忪殂鲲殇吁忭轸蔑铘屮轭瘐舡秕麴豸溽翎箦潴族饷镱翦┖篚疱蚝吁忭轸尼翎ㄩ铕豸秕麴豸溽翎箦潴族饷镱翦怡蝈驽蝈钽濠孱礤翳镤吁忭轸蔑铘屮里疱钺痖镳孱邃珏屮痫螋豉疱舰遗釉躞逡弭躜钪犰蹂舰驷祗澧黩轸迥狒嵊弭洛骘蝈身徵褰㈡犰箦┊鲤蝻珧弩螽箦蝣殂瀹蝈箫躜沐歪痧轭绋豉疱舰遗釉镳弪狒轱罱泔躅簪找山泔躅艨骈祠弪浸骈祠弪", alias="count", mediaType="application/json").
    method public void getCount ( input filter as character, output numRecs as integer ):
        assign numRecs = integer(super:getRecCount(filter)).
    end method. /* getCount */


    @openapi.openedge.export(type="REST", useReturnValue="false", writeDataSetBeforeImage="false").
    @progress.service.resourceMapping(type="REST", operation="invoke", URI="/clear", alias="clear", mediaType="application/json").
    method public void clearContext ( input  contextType    as character,
                                      input  contextViewID  as character,
                                      input  contextTitle   as character,
                                      output clearedRecords as integer ):
        define buffer bContext for WebContext.

        for each bContext exclusive-lock
           where bContext.IdentityName eq oClientContext:userID
             and (contextType eq "" or bContext.ContextType eq contextType)
             and (contextViewID eq "" or bContext.ContextViewID eq contextViewID)
             and (contextTitle eq "" or bContext.ContextTitle eq contextTitle)
             and (contextSeqNo eq ? or bContext.ContextSeqNo eq contextSeqNo):
            message substitute("Deleting context for &1 &2 &3 &4", contextType, contextViewID, contextTitle, contextSeqNo).
            delete bContext. /* Delete matching record. */
            assign clearedRecords = clearedRecords + 1.
        end. /* for each */
    end method. /* clearContext */


    @openapi.openedge.export(type="REST", useReturnValue="false", writeDataSetBeforeImage="false").
    @progress.service.resourceMapping(type="REST", operation="invoke", URI="/roles", alias="roles", mediaType="application/json").
    method public void getRoles ( input  clientID     as character,
                                  output allowedRoles as JsonArray ):
        define variable cRoles as character no-undo.
        define variable iX     as integer   no-undo.

        allowedRoles = new JsonArray(). /* Set to empty array. */

        if valid-object(oClientContext) then do:
            assign cRoles = oClientContext:clientPrincipal:roles.
            do iX = 1 to num-entries(cRoles):
                allowedRoles:Add(substitute("&1:&2", clientID, substring(entry(iX, cRoles), 6))).
            end. /* iX */
        end. /* valid-object */
    end method. /* getRoles */

end class.
